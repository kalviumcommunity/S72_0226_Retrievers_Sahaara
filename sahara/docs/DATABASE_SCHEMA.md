# Firestore Database Schema

## Overview

Sahara uses Cloud Firestore as its primary database. This document outlines the complete database structure, including collections, documents, and relationships.

## Collections Structure

```
firestore/
├── users/
│   └── {userId}
├── caregivers/
│   └── {userId}
├── pets/
│   └── {petId}
├── bookings/
│   ├── {bookingId}
│   └── activities/
│       └── {activityId}
├── reviews/
│   └── {reviewId}
└── chats/
    ├── {chatId}
    └── messages/
        └── {messageId}
```

---

## Collection: `users`

Stores basic user information for both pet owners and caregivers.

**Document ID**: `{userId}` (auto-generated by Firebase Auth)

### Schema

```json
{
  "userId": "string",
  "email": "string",
  "role": "owner | caregiver",
  "name": "string",
  "phone": "string",
  "phoneVerified": "boolean",
  "profilePhoto": "string (Storage URL)",
  "location": {
    "address": "string",
    "geopoint": {
      "latitude": "number",
      "longitude": "number"
    }
  },
  "createdAt": "timestamp",
  "lastActive": "timestamp"
}
```

### Example

```json
{
  "userId": "abc123",
  "email": "priya@example.com",
  "role": "owner",
  "name": "Priya Sharma",
  "phone": "+919876543210",
  "phoneVerified": true,
  "profilePhoto": "gs://bucket/users/abc123.jpg",
  "location": {
    "address": "Hinjewadi Phase 1, Pune",
    "geopoint": {
      "latitude": 18.5916,
      "longitude": 73.7331
    }
  },
  "createdAt": "2026-01-15T10:30:00Z",
  "lastActive": "2026-01-30T14:20:00Z"
}
```

### Indexes Required
- `role` (ascending)
- `createdAt` (descending)

---

## Collection: `caregivers`

Stores professional information for caregivers.

**Document ID**: `{userId}` (same as user document)

### Schema

```json
{
  "userId": "string",
  "bio": "string",
  "experienceYears": "number",
  "hourlyRate": "number",
  "servicesOffered": ["string"],
  "petTypesHandled": ["string"],
  "certifications": [
    {
      "name": "string",
      "issuedBy": "string",
      "documentUrl": "string"
    }
  ],
  "verificationStatus": "pending | verified | rejected",
  "verificationDocuments": {
    "idProof": "string (Storage URL)",
    "idProofType": "aadhaar | pan | passport"
  },
  "serviceAreas": [
    {
      "name": "string",
      "geopoint": {
        "latitude": "number",
        "longitude": "number"
      },
      "radiusKm": "number"
    }
  ],
  "availability": {
    "monday": ["string"],
    "tuesday": ["string"],
    "wednesday": ["string"],
    "thursday": ["string"],
    "friday": ["string"],
    "saturday": ["string"],
    "sunday": ["string"]
  },
  "stats": {
    "totalBookings": "number",
    "completedBookings": "number",
    "cancelledBookings": "number",
    "averageRating": "number",
    "totalReviews": "number"
  },
  "isActive": "boolean",
  "createdAt": "timestamp"
}
```

### Example

```json
{
  "userId": "xyz789",
  "bio": "Passionate dog lover with 3 years of experience",
  "experienceYears": 3,
  "hourlyRate": 400,
  "servicesOffered": ["walking", "daycare", "training"],
  "petTypesHandled": ["dogs", "cats"],
  "certifications": [
    {
      "name": "Pet First Aid",
      "issuedBy": "Red Cross",
      "documentUrl": "gs://bucket/certs/xyz789_cert1.pdf"
    }
  ],
  "verificationStatus": "verified",
  "verificationDocuments": {
    "idProof": "gs://bucket/docs/xyz789_aadhaar.jpg",
    "idProofType": "aadhaar"
  },
  "serviceAreas": [
    {
      "name": "Hinjewadi",
      "geopoint": {
        "latitude": 18.5916,
        "longitude": 73.7331
      },
      "radiusKm": 5
    }
  ],
  "availability": {
    "monday": ["09:00-12:00", "15:00-18:00"],
    "tuesday": ["09:00-12:00", "15:00-18:00"],
    "wednesday": ["09:00-12:00"],
    "thursday": ["09:00-12:00", "15:00-18:00"],
    "friday": ["09:00-12:00", "15:00-18:00"],
    "saturday": ["10:00-16:00"],
    "sunday": []
  },
  "stats": {
    "totalBookings": 45,
    "completedBookings": 42,
    "cancelledBookings": 3,
    "averageRating": 4.7,
    "totalReviews": 38
  },
  "isActive": true,
  "createdAt": "2025-10-20T08:00:00Z"
}
```

### Indexes Required
- Composite: `verificationStatus` (asc), `stats.averageRating` (desc), `isActive` (asc)
- `stats.averageRating` (descending)
- `hourlyRate` (ascending)

---

## Collection: `pets`

Stores pet information for owners.

**Document ID**: Auto-generated

### Schema

```json
{
  "petId": "string",
  "ownerId": "string",
  "name": "string",
  "type": "dog | cat | bird | other",
  "breed": "string",
  "age": "number",
  "weight": "number",
  "gender": "male | female",
  "photo": "string (Storage URL)",
  "specialNeeds": "string",
  "medicalInfo": "string",
  "createdAt": "timestamp"
}
```

### Example

```json
{
  "petId": "pet001",
  "ownerId": "abc123",
  "name": "Bruno",
  "type": "dog",
  "breed": "Golden Retriever",
  "age": 2,
  "weight": 30,
  "gender": "male",
  "photo": "gs://bucket/pets/pet001.jpg",
  "specialNeeds": "Scared of loud noises, prefers quiet parks",
  "medicalInfo": "Vaccinated, no allergies",
  "createdAt": "2026-01-15T11:00:00Z"
}
```

### Indexes Required
- `ownerId` (ascending)
- Composite: `ownerId` (asc), `createdAt` (desc)

---

## Collection: `bookings`

Stores booking information between owners and caregivers.

**Document ID**: Auto-generated

### Schema

```json
{
  "bookingId": "string",
  "ownerId": "string",
  "caregiverId": "string",
  "petId": "string",
  "serviceType": "walking | daycare | overnight | training",
  "status": "pending | confirmed | in-progress | completed | cancelled",
  "scheduledDate": "string (YYYY-MM-DD)",
  "scheduledTime": "string (HH:MM)",
  "duration": "number (minutes)",
  "specialInstructions": "string",
  "pricing": {
    "hourlyRate": "number",
    "totalHours": "number",
    "totalAmount": "number"
  },
  "sessionData": {
    "startTime": "timestamp",
    "endTime": "timestamp",
    "actualDuration": "number (minutes)"
  },
  "createdAt": "timestamp",
  "updatedAt": "timestamp"
}
```

### Example

```json
{
  "bookingId": "bk2026001",
  "ownerId": "abc123",
  "caregiverId": "xyz789",
  "petId": "pet001",
  "serviceType": "walking",
  "status": "completed",
  "scheduledDate": "2026-01-28",
  "scheduledTime": "16:00",
  "duration": 60,
  "specialInstructions": "Please take Bruno to the dog park",
  "pricing": {
    "hourlyRate": 400,
    "totalHours": 1,
    "totalAmount": 400
  },
  "sessionData": {
    "startTime": "2026-01-28T16:05:00Z",
    "endTime": "2026-01-28T17:10:00Z",
    "actualDuration": 65
  },
  "createdAt": "2026-01-25T12:30:00Z",
  "updatedAt": "2026-01-28T17:10:00Z"
}
```

### Indexes Required
- Composite: `ownerId` (asc), `status` (asc), `scheduledDate` (desc)
- Composite: `caregiverId` (asc), `status` (asc), `scheduledDate` (desc)
- `status` (ascending)

---

## Subcollection: `bookings/{bookingId}/activities`

Stores real-time activity updates during a booking session.

**Document ID**: Auto-generated

### Schema

```json
{
  "activityId": "string",
  "bookingId": "string",
  "type": "photo | text | milestone",
  "message": "string",
  "photoUrl": "string (Storage URL)",
  "timestamp": "timestamp",
  "uploadedBy": "string (userId)"
}
```

### Example

```json
{
  "activityId": "act001",
  "bookingId": "bk2026001",
  "type": "photo",
  "message": "Playing fetch at the park!",
  "photoUrl": "gs://bucket/activities/act001.jpg",
  "timestamp": "2026-01-28T16:25:00Z",
  "uploadedBy": "xyz789"
}
```

### Indexes Required
- Composite: `bookingId` (asc), `timestamp` (desc)

---

## Collection: `reviews`

Stores reviews and ratings for caregivers.

**Document ID**: Auto-generated

### Schema

```json
{
  "reviewId": "string",
  "bookingId": "string",
  "caregiverId": "string",
  "ownerId": "string",
  "rating": "number (1-5)",
  "comment": "string",
  "photos": ["string"],
  "caregiversResponse": "string",
  "createdAt": "timestamp"
}
```

### Example

```json
{
  "reviewId": "rev001",
  "bookingId": "bk2026001",
  "caregiverId": "xyz789",
  "ownerId": "abc123",
  "rating": 5,
  "comment": "Rahul was amazing with Bruno! Sent lots of photos and Bruno came home happy and tired. Highly recommend!",
  "photos": ["gs://bucket/reviews/rev001_1.jpg"],
  "caregiversResponse": "Thank you Priya! Bruno is a joy to walk with!",
  "createdAt": "2026-01-28T18:00:00Z"
}
```

### Indexes Required
- Composite: `caregiverId` (asc), `createdAt` (desc)
- `rating` (descending)

---

## Collection: `chats`

Stores chat conversations between owners and caregivers.

**Document ID**: Composite of userIds (e.g., "abc123_xyz789")

### Schema

```json
{
  "chatId": "string",
  "participants": ["string"],
  "lastMessage": "string",
  "lastMessageTime": "timestamp",
  "unreadCount": {
    "userId1": "number",
    "userId2": "number"
  }
}
```

### Example

```json
{
  "chatId": "abc123_xyz789",
  "participants": ["abc123", "xyz789"],
  "lastMessage": "See you tomorrow at 4 PM!",
  "lastMessageTime": "2026-01-27T20:15:00Z",
  "unreadCount": {
    "abc123": 0,
    "xyz789": 2
  }
}
```

---

## Subcollection: `chats/{chatId}/messages`

Stores individual messages in a chat.

**Document ID**: Auto-generated

### Schema

```json
{
  "messageId": "string",
  "senderId": "string",
  "text": "string",
  "timestamp": "timestamp",
  "read": "boolean"
}
```

### Example

```json
{
  "messageId": "msg001",
  "senderId": "abc123",
  "text": "Hi! Can you take Bruno to the riverside park tomorrow?",
  "timestamp": "2026-01-27T20:10:00Z",
  "read": true
}
```

### Indexes Required
- Composite: `chatId` (asc), `timestamp` (asc)

---

## Security Rules

### Firestore Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Caregivers collection
    match /caregivers/{caregiverId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(caregiverId);
    }
    
    // Pets collection
    match /pets/{petId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
                                resource.data.ownerId == request.auth.uid;
    }
    
    // Bookings collection
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && 
                     (resource.data.ownerId == request.auth.uid || 
                      resource.data.caregiverId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || 
                        resource.data.caregiverId == request.auth.uid);
      
      // Activities subcollection
      match /activities/{activityId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
      }
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.ownerId);
    }
    
    // Chats collection
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && 
                            request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, write: if isAuthenticated();
      }
    }
  }
}
```

---

## Data Relationships

```
users (1) ──────────── (1) caregivers
  │
  │ (1:N)
  │
pets
  │
  │ (N:1)
  │
bookings ──────────── (N:1) caregivers
  │
  │ (1:N)
  │
activities

bookings ──────────── (1:1) reviews

users ──────────── (N:N) chats ──────────── (1:N) messages
```

---

## Query Examples

### Get verified caregivers near location

```dart
final snapshot = await FirebaseFirestore.instance
    .collection('caregivers')
    .where('verificationStatus', isEqualTo: 'verified')
    .where('isActive', isEqualTo: true)
    .where('stats.averageRating', isGreaterThanOrEqualTo: 4.0)
    .orderBy('stats.averageRating', descending: true)
    .limit(20)
    .get();
```

### Get user's upcoming bookings

```dart
final snapshot = await FirebaseFirestore.instance
    .collection('bookings')
    .where('ownerId', isEqualTo: userId)
    .where('status', whereIn: ['pending', 'confirmed'])
    .orderBy('scheduledDate', descending: false)
    .get();
```

### Listen to real-time activity updates

```dart
FirebaseFirestore.instance
    .collection('bookings')
    .doc(bookingId)
    .collection('activities')
    .orderBy('timestamp', descending: true)
    .snapshots()
    .listen((snapshot) {
      // Handle updates
    });
```

---

## Best Practices

1. **Use subcollections** for one-to-many relationships (activities, messages)
2. **Denormalize data** when needed for performance (caregiver stats)
3. **Create composite indexes** for complex queries
4. **Use transactions** for atomic operations (booking creation)
5. **Implement pagination** for large lists
6. **Cache frequently accessed data** in Provider
7. **Use batch writes** for multiple operations
8. **Monitor Firestore usage** to optimize costs
